---
title: Architecture Diagrams
description: Verifio's system architecture and service communication patterns.
---

import { Callout } from 'fumadocs-ui/components/callout'

Verifio's system architecture, service communication, and data flow patterns.

## System Architecture Overview

### Component Structure

| Layer | Components | Purpose |
|-------|-----------|---------|
| **Users** | End Users, Dashboard Users, API Consumers | Consumers of the platform |
| **Frontend Layer** | Web App (:3000), Dashboard (:3001), Docs (:3002), Blog (:3003) | User interfaces |
| **API Gateway** | Caddy Reverse Proxy (local.verifio.email) | HTTPS termination and routing |
| **Backend Services** | Auth (:8000), Verify (:8001), API Key (:8002), Logs (:8003), Upload (:8004), Credits (:8005), Tools (:8006) | Core services |
| **Data Layer** | PostgreSQL, Redis | Database and cache |
| **Infrastructure** | Inngest | Background job processing |

### Service Communication Flow

```
Frontend Apps → Caddy Proxy → Backend Services → Database/Cache
```

**Key Points:**
- All traffic goes through Caddy reverse proxy
- Frontend apps communicate via Caddy
- Backend services communicate with PostgreSQL and Redis
- Verify service depends on Auth and Credits services
- Upload service uses Inngest for background jobs

## Authentication Flows

### Email/Password Authentication

**Steps:**
1. User enters email/password in frontend
2. Frontend sends POST request to `/api/auth/v1/sign-in/email`
3. Auth service validates credentials against database
4. On success: Creates session in Redis
5. Auth service returns session cookie via Caddy
6. Frontend redirects user to dashboard

**Error Handling:**
- Invalid credentials → Return 401 Unauthorized
- User not found → Return 404

### OAuth Authentication (Google/GitHub)

**Steps:**
1. User clicks "Sign in with Google/GitHub"
2. Frontend redirects to Auth service OAuth endpoint
3. Auth service redirects to OAuth provider
4. User grants permission on provider's site
5. Provider redirects back to Auth service with authorization code
6. Auth service exchanges code for access tokens
7. Auth service creates/updates user account in database
8. Auth service creates session in Redis
9. Auth service redirects to dashboard with session cookie

### API Key Authentication

**Steps:**
1. Client includes API key in `Authorization` or `X-API-Key` header
2. Service receives request and extracts API key
3. Service calls API Key service to validate
4. API Key service looks up hashed key in database
5. If valid and enabled: Returns organization/user info
6. Service processes request
7. Service logs activity to Logs service
8. Service returns response to client

**Error Cases:**
- Invalid key → 401 Unauthorized
- Disabled key → 401 Unauthorized
- Expired key → 401 Unauthorized
- Rate limit exceeded → 429 Too Many Requests

## Email Verification Flow

### Single Email Verification

| Step | Service | Action |
|------|---------|--------|
| 1 | Client | Sends POST request with email |
| 2 | Verify Service | Checks available credits with Credits service |
| 3 | Credits Service | Returns credits available |
| 4 | Verify Service | Performs verification (syntax, DNS, MX, SMTP) |
| 5 | Verify Service | Stores result in database |
| 6 | Verify Service | Deducts 1 credit from Credits service |
| 7 | Verify Service | Logs activity to Logs service |
| 8 | Verify Service | Returns result to client |

**Response Time:** 2-5 seconds

### Bulk Email Verification

| Step | Service | Action |
|------|---------|--------|
| 1 | Client | Uploads file with emails |
| 2 | Upload Service | Stores file, returns file ID |
| 3 | Verify Service | Creates job record (status: pending) |
| 4 | Verify Service | Returns job ID to client immediately |
| 5 | Verify Service | Triggers Inngest background job |
| 6 | Inngest | Processes emails in batches of 10 |
| 7 | Verify Service | Updates job progress after each batch |
| 8 | Verify Service | Stores individual results |
| 9 | Inngest | On completion, deducts credits from Credits service |
| 10 | Verify Service | Updates job status to completed |
| 11 | Logs Service | Logs completion |
| 12 | Client | Polls for job status and results |

**Batch Size:** 10 emails processed concurrently
**Max Emails:** 10,000 per bulk job

## Credit Management Flow

### Lazy Reset Pattern

| Trigger | Action |
|---------|--------|
| First credit operation of period | Check if period expired |
| Period expired | Archive old period to history |
| Archive complete | Reset `creditsUsed` to 0 |
| Reset complete | Set new `periodStart` and `periodEnd` |

### Credit Check & Deduction

**Check Flow:**
1. Service receives request that requires credits
2. Service calls Credits service: `POST /api/credits/v1/available-credits`
3. Credits service checks `orgCredits` table
4. If period expired: Performs lazy reset
5. Credits service calculates available credits
6. Returns: `creditsAvailable = creditLimit - creditsUsed`

**Deduction Flow:**
1. Service completes operation
2. Service calls Credits service: `POST /api/credits/v1/deduct`
3. Credits service performs atomic SQL update:
   ```sql
   UPDATE org_credits
   SET credits_used = credits_used + amount
   WHERE id = org_id
     AND credit_limit - credits_used >= amount
   RETURNING *;
   ```
4. If query returns row: Success
5. If query returns null: Insufficient credits (shouldn't happen if checked first)

**Atomic Guarantee:** Prevents double-spending and race conditions

## API Request Flows

### Session-Based Request

| Step | Component | Action |
|------|-----------|--------|
| 1 | Client | Sends request with session cookie |
| 2 | Service | Extracts session cookie |
| 3 | Service | Calls Auth service: `/api/auth/v1/get-session` |
| 4 | Auth Service | Validates session in Redis |
| 5 | Auth Service | Returns user and organization info |
| 6 | Service | Checks user permissions |
| 7 | Service | If credits needed: Checks Credits service |
| 8 | Service | Processes request |
| 9 | Service | Logs activity |
| 10 | Service | Returns response |

### API Key-Based Request

| Step | Component | Action |
|------|-----------|--------|
| 1 | Client | Sends request with API key header |
| 2 | Service | Extracts API key |
| 3 | Service | Calls API Key service: `/api/api-key/v1/verify` |
| 4 | API Key Service | Validates key in database |
| 5 | API Key Service | Checks if enabled |
| 6 | API Key Service | Checks rate limits |
| 7 | API Key Service | Updates request count |
| 8 | API Key Service | Returns organization/user info |
| 9 | Service | Checks permissions |
| 10 | Service | If credits needed: Checks Credits service |
| 11 | Service | Processes request |
| 12 | Service | Logs activity with API key ID |
| 13 | Service | Returns response |

## Service Dependencies

### Direct Dependencies

| Service | Depends On | Purpose |
|---------|-----------|---------|
| **Verify** | Auth | Validate user sessions |
| **Verify** | Credits | Check/deduct credits |
| **Verify** | Logs | Log verification activity |
| **API Key** | Auth | Get user context |
| **API Key** | Logs | Log key operations |
| **Credits** | Auth | Get organization context |
| **Credits** | Logs | Log credit operations |
| **Upload** | Auth | Validate user sessions |
| **Upload** | Logs | Log upload activity |
| **Upload** | Inngest | Background file processing |
| **Tools** | Logs | Log tool usage |

### Startup Order

1. **Infrastructure** (must start first):
   - PostgreSQL
   - Redis
   - Caddy
   - Inngest

2. **Core Services** (no dependencies):
   - Auth Service
   - API Key Service
   - Credits Service
   - Tools Service

3. **Dependent Services**:
   - Verify Service (depends on: Auth, Credits)
   - Upload Service (depends on: Auth)
   - Logs Service (depends on: Auth)

## Database Relationships

### User & Organization

| Relationship | Type | Description |
|--------------|------|-------------|
| User → Sessions | One-to-Many | User has many sessions |
| User → OAuth Accounts | One-to-Many | User can connect multiple OAuth providers |
| User → Memberships | One-to-Many | User can belong to multiple organizations |
| Organization → Members | One-to-Many | Organization has many members |
| Organization → API Keys | One-to-Many | Organization has many API keys |
| Organization → Credits | One-to-One | Organization has one credit record |
| Organization → Verification Jobs | One-to-Many | Organization has many jobs |
| Organization → Uploads | One-to-Many | Organization has many uploaded files |

### Verification Data

| Relationship | Type | Description |
|--------------|------|-------------|
| Job → Results | One-to-Many | One job has many verification results |
| Job → Upload | Many-to-One | Job may use uploaded file |
| Result → Job | Many-to-One | Result belongs to one job |

## Rate Limiting Architecture

### Multi-Layer Protection

```
Request → IP Limit → Fingerprint Limit → Email Limit → API Key Limit → Process
```

### Rate Limit Tiers

| Type | Scope | Limit | Window |
|------|-------|-------|--------|
| IP-based | IP address | 10 requests | 1 minute |
| Fingerprint | Browser fingerprint | 15 requests | 1 minute |
| Email-based | Email address | 5 requests | 15 minutes |
| Signup | IP address | 3 requests | 1 minute |
| Password Reset | Email address | 3 requests | 5 minutes |
| API Key | Per key | Configurable | Configurable |

### Redis Implementation

- **Key Format:** `ratelimit:{identifier}:{endpoint}`
- **Data Structure:** Sorted set with timestamps
- **Expiration:** Automatic cleanup after window expires
- **Algorithm:** Sliding window for accuracy

## Security Layers

### Layer-by-Layer Protection

| Layer | Protection | Example |
|-------|-----------|---------|
| 1. Network | HTTPS only | Caddy terminates TLS |
| 2. CORS | Origin validation | Only allow trusted domains |
| 3. Rate Limiting | Multi-tier | IP → Fingerprint → Email → API Key |
| 4. Authentication | Session or API Key | Required for most endpoints |
| 5. Authorization | Organization-based | Users can only access their data |
| 6. Input Validation | Schema validation | All inputs validated with Zod |
| 7. Rate Limits | Credit checks | Prevent credit exhaustion |
| 8. Audit Logging | All actions logged | Stored in activityLogs table |

## Deployment Architecture

### Local Development

```
Developer's Machine
├── Docker Compose
│   ├── PostgreSQL (:5432)
│   ├── Redis (:6379)
│   ├── Caddy (:8080)
│   └── Inngest (:8288)
├── Backend Services (Bun)
│   ├── Auth (:8000)
│   ├── Verify (:8001)
│   ├── API Key (:8002)
│   ├── Logs (:8003)
│   ├── Upload (:8004)
│   ├── Credits (:8005)
│   └── Tools (:8006)
└── Frontend Apps (Next.js)
    ├── Web (:3000)
    ├── Dashboard (:3001)
    ├── Docs (:3002)
    └── Blog (:3003)
```

**Key Differences from Production:**
- All services on `localhost`
- HTTP for local development (HTTPS via Caddy)
- Single Docker Compose for infrastructure
- No load balancing

### Production (Simplified)

```
Users
    ↓
CDN / Load Balancer (Cloudflare/AWS)
    ↓
Application Servers
    ├── Frontend Cluster (multiple instances)
    └── Backend Cluster (multiple instances per service)
        ├── Auth Service
        ├── Verify Service
        ├── API Key Service
        ├── Credits Service
        ├── Logs Service
        └── Upload Service
    ↓
Data Layer
    ├── RDS PostgreSQL (Multi-AZ)
    └── ElastiCache Redis (Cluster Mode)
    ↓
Background Jobs
    └── Inngest Cloud
```

**Key Production Features:**
- CDN for static assets
- Load balancing for high availability
- Multiple service instances
- Managed database services
- Auto-scaling capabilities

## Related Documentation

- **Backend Architecture** - Detailed technical architecture
- **Database Schema** - Complete data model
- **Authentication & Security** - Security implementation details
- **Individual Service Docs** - Service-specific architecture
