---
title: Credits Service
description: Credit management and billing.
---

Credit tracking, usage, and monthly billing cycles.

## Quick Start

| Property | Value |
|----------|-------|
| **Location** | `apps/backend/credits` |
| **Port** | 8005 |
| **Start Command** | `bun run be:credits:dev` |

## Environment Variables

```bash
PORT=8005
BASE_URL=https://local.verifio.email
PG_URL=postgresql://verifio:verifio123@localhost:5432/verifio
REDIS_URL=redis://:verifio123@localhost:6379
DEFAULT_CREDIT_LIMIT=3000
```

## Main Endpoints

| Route | Method | Description | Auth Required |
|-------|--------|-------------|---------------|
| `/api/credits/v1/status` | POST | Get credit status | Session |
| `/api/credits/v1/history` | GET | Get usage history | Session |
| `/api/credits/v1/available-credits` | GET | Check credits | Session or Internal |
| `/api/credits/v1/deduct` | POST | Deduct credits | Session or Internal |
| `/api/credits/health` | GET | Health check | No |

## Credit Management

**Lazy Reset Pattern:**
- Credits reset automatically on first operation of new period
- Old period archived to `creditHistory` table
- Prevents race conditions with atomic SQL operations

**Atomic Deduction:**
```sql
UPDATE org_credits
SET credits_used = credits_used + amount
WHERE id = org_id
  AND credit_limit - credits_used >= amount
```

## Database Tables

- `orgCredits` - Current billing period (1:1 per org)
- `creditHistory` - Past billing periods

## Common Issues

**"Insufficient credits":**
- Check credit status in dashboard
- Wait for monthly reset if applicable

**Credits not resetting:**
- Trigger reset by making any credit operation
- Check `periodEnd` in database

**"Double deduction":**
- Should not happen due to atomic operations
- Report if seen
